# Online Multiplayer Implementation Guide

## Overview
Online multiplayer for Mexican Dice has been implemented using Supabase PostgreSQL for game state persistence. The implementation reuses Quick Play's game logic WITHOUT duplication.

## Architecture

### Key Files Created/Modified

#### New Engine Files (Shared Logic)
- **`src/engine/onlineRoll.ts`** - Dice rolling helper
  - `rollDice()`: Generates and normalizes dice rolls
  - `computeLegalTruth()`: Validates if a roll can be claimed truthfully

- **`src/engine/onlineActions.ts`** - Core game logic extracted from Quick Play
  - `CoreGameState` type: Simplified state for multiplayer games
  - `applyClaim()`: Validates and processes claims with all rules:
    - Mexican lockdown (21 must be answered with 21/31/41)
    - Social showing (41 must be truthful)
    - Reverse claims (31/41) with baseline tracking
    - Legality checks using engine functions
  - `applyCallBluff()`: Resolves bluff calls using `resolveBluff()` from engine
    - Applies score penalties (1 or 2 points)
    - Detects winner when score reaches 0

#### Modified Files
- **`app/online/[gameId].tsx`** - Online match screen
  - Added `BluffModal` for claim selection
  - Implemented handlers:
    - `handleRoll()`: Rolls dice and persists to Supabase
    - `handleClaim()`: Validates and applies claims
    - `handleCallBluff()`: Resolves bluff calls
  - Added mapper functions to convert between Supabase and CoreGameState
  - Wired all buttons to handlers

### Database Schema

The `games` table requires these columns:

```sql
-- Core game state
id TEXT PRIMARY KEY
player1_id TEXT NOT NULL
player2_id TEXT
player1_username TEXT NOT NULL
player2_username TEXT
player1_score INTEGER DEFAULT 5
player2_score INTEGER DEFAULT 5
current_player TEXT CHECK (current_player IN ('player1', 'player2'))
status TEXT DEFAULT 'waiting' CHECK (status IN ('waiting', 'active', 'finished'))
winner TEXT CHECK (winner IN ('player1', 'player2'))

-- Join tracking
player1_joined BOOLEAN DEFAULT false
player2_joined BOOLEAN DEFAULT false

-- Gameplay state
current_claim TEXT
current_roll TEXT
baseline_claim TEXT  -- NEW: Tracks original claim through reverses
last_action TEXT DEFAULT 'normal' CHECK (last_action IN ('normal', 'reverseVsMexican'))  -- NEW

-- Timestamps
created_at TIMESTAMP DEFAULT NOW()
updated_at TIMESTAMP DEFAULT NOW()
```

**Migration Required**: Run `supabase-migration-add-claim-columns.sql` to add the new columns.

## How It Works

### Game Flow

1. **Game Creation** (handled previously)
   - Player creates game with friend's username
   - Game inserted into Supabase with `status: 'waiting'`

2. **Joining**
   - Both players open match screen at `/online/[gameId]`
   - `player1_joined` and `player2_joined` flags set to `true`
   - When both joined, status changes to `'active'`

3. **Turn-Based Gameplay**
   - `isMyTurn` computed from `game.current_player` vs `myUserId`
   - Buttons disabled when not player's turn

4. **Roll**
   - Player presses "Roll" button
   - `handleRoll()` calls `rollDice()` from onlineRoll.ts
   - Normalized dice stored in `myRoll` state and `current_roll` in DB
   - Roll button disabled after rolling (until next turn)

5. **Claim**
   - Player presses "Bluff Options" button
   - `BluffModal` opens with legal claim options (generated by `buildClaimOptions()`)
   - Player selects a claim
   - `handleClaim()`:
     - Converts game to `CoreGameState`
     - Calls `applyClaim()` with shared logic
     - Validates claim legality (Mexican lockdown, Social rules, etc.)
     - Updates Supabase with new claim, baseline, turn switch
     - Clears `myRoll` after successful claim

6. **Call Bluff**
   - Player presses "Call Bluff" button (when opponent has made a claim)
   - `handleCallBluff()`:
     - Reads opponent's actual roll from `current_roll` field
     - Calls `applyCallBluff()` with shared logic
     - `resolveBluff()` determines outcome and penalty
     - Updates scores in Supabase
     - Displays alert with result message
     - Detects winner if score reaches 0

### Special Rules Handled

All Mexican Dice rules are enforced via `onlineActions.ts`:

- **Mexican Lockdown**: After 21 is claimed, only 21/31/41 are legal
  - Violation costs 2 points automatically
- **Social (41)**: Must be shown truthfully, cannot be bluffed
- **Reverse Claims (31/41)**: Turn passes back, baseline preserved
- **ReverseVsMexican**: 31 after 21 triggers 2-point penalty on bluff
- **Baseline Tracking**: Original claim preserved through reverse chains

## Code Reuse Strategy

**Quick Play logic was NOT modified.** Instead:

1. Analyzed `useGameStore.ts` functions:
   - `playerClaim()` (lines 907-1050)
   - `processCallBluff()` (lines 550-620)
   - `callBluff()` (line 1051)

2. Extracted **pure game logic** (rules, validation, scoring) into `onlineActions.ts`

3. Left **AI opponent, Zustand state, UI concerns** in Quick Play

4. Created **mapper functions** to convert between:
   - Supabase game rows â†” CoreGameState
   - This allows online play to use same engine functions

## Testing Checklist

### Before Deployment
- [ ] Run database migration: `supabase-migration-add-claim-columns.sql`
- [ ] Test Roll functionality (dice show correct values)
- [ ] Test Claim functionality (legal claims accepted, illegal rejected)
- [ ] Test Mexican lockdown (21 forces 21/31/41 response)
- [ ] Test Social (41 must match actual roll)
- [ ] Test Call Bluff (correct/incorrect calls update scores)
- [ ] Test winner detection (game ends at 0 points)
- [ ] Test reverse claims (31/41 preserve baseline)

### Known Limitations
- **No real-time updates**: Opponent must refresh to see changes
  - TODO: Add Supabase Realtime subscriptions
- **Opponent roll visibility**: Currently visible in DB
  - TODO: Hide `current_roll` until bluff called or shown
- **No victory screen**: Just shows alert
  - TODO: Add proper endgame modal
- **Network errors**: Basic error handling only
  - TODO: Add retry logic and conflict resolution

## Next Steps

### Priority 1: Real-Time Updates
Add Supabase Realtime subscription in `useEffect`:
```typescript
const subscription = supabase
  .channel('game-updates')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'games',
    filter: `id=eq.${gameId}`,
  }, (payload) => {
    setGame(payload.new as OnlineGame);
  })
  .subscribe();
```

### Priority 2: Security
- Add Row Level Security (RLS) policies in Supabase
- Hide opponent's `current_roll` field from client queries
- Validate moves server-side with Edge Functions

### Priority 3: UX Improvements
- Victory/defeat modal with rematch option
- In-game chat or emojis
- Abandon/forfeit functionality
- Reconnection handling

## File Summary

**New Files:**
- `src/engine/onlineRoll.ts` (38 lines)
- `src/engine/onlineActions.ts` (212 lines)
- `supabase-migration-add-claim-columns.sql` (12 lines)
- This guide (`ONLINE_MULTIPLAYER_IMPLEMENTATION.md`)

**Modified Files:**
- `app/online/[gameId].tsx` (~200 lines added)
  - Imports, state, handlers, BluffModal integration

**Total Lines Added:** ~460 lines of production code + migration + docs

**Lines Duplicated from Quick Play:** 0 (all logic reused via shared functions)
